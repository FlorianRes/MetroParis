<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="utf-8">

		<!-- VIEWPORT POUR MOBILE -->
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0" />
		<title>MetroParis</title>
		<link rel="stylesheet" type="text/css" href="css/style.css" />
	</head>
	<body>

		<!-- LA CARTE -->
		<div id="map" id="viewport">
			<svg id="svg" viewBox="0 0 4600 4600">
				<g>
				</g>
			</svg>
		</div>

		<!-- LE MENU -->
		<div id="menu">
			<input id="depart" list="stations"><br>
			<input id="arrive" list="stations"><br>
			<input id="btn-calcul" type="submit"/>
			<input id="btn-reset" type="reset"/>
			<datalist id="stations">

			</datalist>
			<p id="itineraire"></p>
		</div>

		<!-- LES SCRIPTS -->
		<script type="text/javascript" src="js/jquery-2.1.0.min.js"></script>
		<script type="text/javascript" src="js/hammer.js"></script>
		<script type="text/javascript" src="js/jquery.hammer.js"></script>
		<script type="text/javascript" src="js/hammer.fakemultitouch.js"></script>
		<script type="text/javascript" src="js/hammer.showtouches.js"></script>
		<script type="text/javascript" src="js/gesture.js"></script>
		<script type="text/javascript" src="js/graph.js"></script>
		<script type="text/javascript" src="js/metroparis.js"></script>
		<script type="text/javascript" src="js/itineraire.js"></script>		
		<script type="text/javascript" src="js/svg-pan-zoom.js"></script>
		<script type="text/javascript">
			

			Hammer.plugins.fakeMultitouch();
			Hammer.plugins.showTouches();

			// PLACEMENT DES LIGNES

			str = "";
			for(var i in listeLignes){
				stations = listeLignes[i].stations;
				for(var j in stations){
					obj = stations[j];
					str += (j==0?"":",") + obj.position[0] + "," + obj.position[1];
				}
				$('#map > svg > g').append('<polyline points="' + str + '" style="fill:none;stroke:' + listeLignes[i].couleur + ';stroke-width:10;stroke-opacity:0.5;stroke-dasharray: 10 5 5 10; stroke-dashoffset:20" />');
				str = "";
			}

			// PLACEMENT DES STATIONS

			for(var i in listeStations){
				station = listeStations[i];
				x = station.position[0];
				y = station.position[1];
				xt = station.position[2];
				yt = station.position[3];
				id = station.identifiant.split("/")[0];
				$arg = $('#' + id);
				$map = $('#map > svg > g');
				if($arg.length == 0){
					$map.append('<a><circle id="' + id + '" cx="' + x + '" cy="' + y + '" r=8 fill="' + station.ligne.couleur + '" /></a><text x="' + (x + xt) + '" y="' + (y + yt) +'" fill="black" font-family="arial">' + station.nom + '</text>');
				}else if($arg.attr('fill') != station.ligne.couleur){
					$arg.remove();
					$map.append('<a><circle id="' + id + '" cx="' + x + '" cy="' + y + '" r="10" stroke="black" stroke-width="1" fill="white" /></a>');
				}
			}

			// SCRIPT QUI LORSQU'ON CLIQUE SUR LES LIENS <a> CELA PERMET UNE INTERACTION 


			//


			// REFRESH AFFICHAGE
			$("#map").html($("#map").html());
			zoomInit();

			// LISTE DES STATIONS DU FORMULAIRE
			for(var i in listeStations){
				if($('#stations > option[value="' + listeStations[i].nom + '"]').length == 0){
					$('#stations').append('<option value="'+ listeStations[i].nom + '">');
				}
			}

			// BOUTON DE CALCUL D'ITINERAIRE

			$('#btn-calcul').click(function calcul(){
				var depart = $('#depart').val();
				var arrive = $('#arrive').val();
				
				var reponse = itineraire(depart,arrive);
				var res = reponse[0];
				var trace = reponse[1];

				var str = "";

				var departObj = nomToObject(depart);
				var str2 = departObj.position[0] + ", " + departObj.position[1];
				for(var i = 0; i < res.length; i++){

					str += "Prendre la ligne " + res[i][0] + (res[i][1]!=res[i][2] ? " vers " + res[i][1] + ",":"") + " jusqu'Ã  " + res[i][2].nom +".<br>";

				}
				$('#itineraire').html(str);

				var str2 = "";
				for(var i in trace){
					obj = trace[i][0];
					str2 += (i==0?"":",") + obj.position[0] + "," + obj.position[1];
				}
				trace = $("#trace");
				if(trace.length>0) trace.remove();
				$('#map > svg > g').append('<polyline id="trace" points="' + str2 + '" style="fill:none;stroke:black;stroke-width:5 ;stroke-dashoffset:20" />');
				
				$("#map").html($("#map").html());
				zoomInit();
			})


			// BOUTON DE RESET DE L'ITINERAIRE

			$('#btn-reset').click(function reset(){
				$('#depart').val("");
				$('#arrive').val("");
				$("#itineraire").html("");
				trace = $("#trace");
				if(trace.length>0) trace.remove();
				
				$("#map").html($("#map").html());
				zoomInit();
			})

			// INITIALISATION DES EVENEMENTS DRAG/PAN/ZOOM

			function zoomInit(){
				svgPanZoom.init({
				  'selector': '#svg',
				  'panEnabled': true, 
				  'zoomEnabled': true,
				  'dragEnabled': false,
				  'zoomScaleSensitivity': 0.2,
				  'minZoom': 0.2,
				  'maxZoom': 10,
				});
			}

		</script>
	</body>
</html>
